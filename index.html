<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NMLS Study Guide</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0a0a0f; font-family: Georgia, serif; color: #e8e4d9; }
    button { font-family: Georgia, serif; cursor: pointer; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <style>
    @keyframes pulse-highlight {
      0%, 100% { background-color: #ffcc4a44; }
      50% { background-color: #ffcc4a88; }
    }
    .speaking-highlight {
      animation: pulse-highlight 1s ease-in-out infinite;
      border-radius: 4px;
      padding: 1px 3px;
    }
  </style>
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    const sections = [
      {
        id: "safe", emoji: "üèõÔ∏è", title: "SAFE Act", color: "#1a3a5c", accent: "#4a9eff",
        items: [
          {
            title: "SAFE Act Basics",
            mnemonic: "SAFE = State + Federal Together",
            facts: ["Signed into law: July 30, 2008","Effective date: August 1, 2009. States had 1 year.","Full name: Secure and Fair Enforcement for Mortgage Licensing Act","Purpose: Create nationwide licensing and registration system for MLOs","Administered by: CFPB since Dodd-Frank 2011","Registry: NMLS ‚Äî Nationwide Multistate Licensing System"],
          },
          {
            title: "Who Needs a License?",
            mnemonic: "ROME = Residential, Originate, Money, Employment",
            facts: ["MLO takes residential mortgage loan applications AND offers or negotiates terms","Must be licensed if employed by non-bank, state-chartered institution","Must be registered if employed by federally chartered bank or credit union","Loan Processors: Generally do NOT need license if clerical only","Underwriters: Generally do NOT need license","Exception: If processor exercises independent judgment = needs license"],
          },
          {
            title: "License Requirements ‚Äî 20-3-8-80",
            mnemonic: "20 dash 3 dash 8 dash 80. Tattoo these on your brain.",
            facts: ["20 hours pre-licensing education required","3 hrs federal law, 3 hrs ethics, 2 hrs non-traditional lending, 12 hrs electives","8 hours annual continuing education","CE: 3 federal law, 2 ethics, 2 non-traditional, 1 elective","75% passing score on SAFE MLO test","Background check and credit report required","Retake: 3 attempts ‚Üí 30-day wait ‚Üí 3 more ‚Üí 6-month wait"],
          },
          {
            title: "Surety Bond & Temporary Authority",
            mnemonic: "Bond = Protection for Borrowers",
            facts: ["States set their own surety bond amounts","Purpose: Protect consumers from MLO fraud or misconduct","Unique identifier required on all loan documents","License renewal: Annual, typically December 31 deadline","Temporary authority: 120 days if changing from bank to non-bank"],
          },
        ],
      },
      {
        id: "trid", emoji: "üìã", title: "TRID ‚Äî RESPA / TILA", color: "#1a3a2a", accent: "#4aff8a",
        items: [
          {
            title: "TRID Key Dates ‚Äî 3, 3, 7",
            mnemonic: "3 days for Loan Estimate. 3 days before closing for CD. 7 days to wait.",
            facts: ["Loan Estimate: Delivered within 3 business days of application","Loan Estimate: Valid for 10 business days","Closing Disclosure: Delivered 3 business days BEFORE closing","Right to rescind: 3 business days after closing ‚Äî refinance only","Zero tolerance: Origination charges cannot increase at closing","10% tolerance: Certain third-party services","Unlimited tolerance: Non-required services borrower shops for"],
          },
          {
            title: "6 Application Triggers ‚Äî ALIENS",
            mnemonic: "ALIENS: A-Address, L-Loan, I-Income, E-Estimated value, N-Name, S-SSN",
            facts: ["A ‚Äî Address of property","L ‚Äî Loan amount","I ‚Äî Income","E ‚Äî Estimated value of property","N ‚Äî Name of borrower","S ‚Äî Social Security Number","Once all 6 collected = APPLICATION EXISTS ‚Üí 3-day clock starts"],
          },
          {
            title: "RESPA Prohibited Acts",
            mnemonic: "No KicKs = No Kickbacks",
            facts: ["Section 8: Prohibits kickbacks and unearned fees","Section 9: Seller cannot require use of specific title company","Section 10: Limits escrow account cushion to 2 months","AfBA: Must disclose, cannot require use","Penalty Section 8: Up to $10,000 fine + 1 year prison","Applies to: Federally related mortgage loans"],
          },
          {
            title: "APR & Finance Charge",
            mnemonic: "APR = All Prepaid Rates included",
            facts: ["APR must be accurate within 1/8% (0.125%) tolerance","Finance charge INCLUDES: points, origination fees, PMI, most closing costs","Finance charge EXCLUDES: appraisal, credit report, title fees","Right of Rescission: Owner-occupied, non-purchase refinance = 3 days","Extended Rescission: If disclosures never given = 3 YEARS","TILA requires: APR, finance charge, amount financed, total payments"],
          },
        ],
      },
      {
        id: "ecoa", emoji: "‚öñÔ∏è", title: "Fair Lending Laws", color: "#3a1a3a", accent: "#ff4adf",
        items: [
          {
            title: "ECOA Protected Classes ‚Äî RACE MAN",
            mnemonic: "RACE MAN: Race, Age, Color, Exercise of rights, Marital status, Alimony, National origin",
            facts: ["R ‚Äî Race","A ‚Äî Age (18+, cannot be used adversely)","C ‚Äî Color","E ‚Äî Exercise of rights under Consumer Protection Act","M ‚Äî Marital status","A ‚Äî Alimony/child support (must consider if disclosed)","N ‚Äî National origin","Also: Religion, Sex, Receipt of public assistance","Adverse Action Notice: 30 days to notify of denial","Recordkeeping: 25 months for applications"],
          },
          {
            title: "Fair Housing Act ‚Äî 7 Classes",
            mnemonic: "Race, Color, Religion, National Origin, Sex, Familial Status, Disability",
            facts: ["Race, Color, Religion, National Origin","Sex (gender)","Familial status (families with children under 18)","Handicap / Disability","Does NOT include: age or marital status federally","Steering: Illegal to direct buyers by race","Redlining: Illegal to deny credit by geography","Blockbusting: Inducing panic selling based on protected class"],
          },
          {
            title: "CRA & HMDA",
            mnemonic: "HMDA = Data Only. Does NOT prohibit discrimination.",
            facts: ["HMDA: Requires lenders to collect and report mortgage data","HMDA does NOT prohibit discrimination ‚Äî just collects data","CRA: Encourages banks to serve entire community","CRA ratings: Outstanding, Satisfactory, Needs to Improve, Substantial Non-Compliance","HMDA asset threshold: $59 million (2026)","LAR: Loan Application Register ‚Äî annual submission"],
          },
          {
            title: "3 Types of Discrimination",
            mnemonic: "3 D's: Disparate Treatment, Disparate Impact, Redlining",
            facts: ["1. Disparate Treatment: Treating similarly situated people differently (intent)","2. Disparate Impact: Neutral policy with discriminatory effect","3. Redlining: Refusing to lend in certain geographic areas","Reverse Redlining: Targeting minority areas with predatory loans","Steering: Directing based on protected class","Blockbusting: Inducing panic selling"],
          },
        ],
      },
      {
        id: "conventional", emoji: "üè†", title: "Loan Types & Guidelines", color: "#2a2a1a", accent: "#ffcc4a",
        items: [
          {
            title: "Conventional Loans ‚Äî 80/20/28/36",
            mnemonic: "80% LTV, 20% down, 28 front-end, 36 back-end",
            facts: ["Conforming loan limit 2026: $832,750 (1-unit)","High-cost areas: up to $1,249,125","PMI required if LTV > 80% (less than 20% down)","PMI cancellation: Request at 80% LTV; auto-cancel at 78% LTV","DTI: Typically 28% front / 36% back","Fannie Mae (FNMA) & Freddie Mac (FHLMC) = GSEs"],
          },
          {
            title: "FHA Loans ‚Äî 3.5% / 580 / MIP",
            mnemonic: "FHA = 3.5% down, 580 score, MIP for life of loan",
            facts: ["Min down payment: 3.5% (score 580+)","Min down payment: 10% (score 500‚Äì579)","MIP Upfront: 1.75% of loan amount","MIP Annual: 0.15%‚Äì0.75% (most borrowers pay 0.55%)","MIP Duration: Life of loan if down < 10%","MIP Duration: 11 years if down ‚â• 10%","Max DTI: 43% typically","FHA insured by: HUD"],
          },
          {
            title: "VA Loans ‚Äî 0% Down / No PMI",
            mnemonic: "VA = Veterans get 0% down, no PMI, but pay Funding Fee",
            facts: ["Down payment: $0 ‚Äî 100% financing","PMI: NONE","Funding fee: 2.15% (first use, no down)","Funding fee waived for: disabled veterans","Certificate of Eligibility (COE) required","No loan limit with full entitlement (post 2020)"],
          },
          {
            title: "USDA Loans ‚Äî Rural / 0% Down",
            mnemonic: "USDA = Rural area, 0% down, income under 115% of median",
            facts: ["Down payment: 0%","Upfront guarantee fee: 1%","Annual fee: 0.35%","Income limit: 115% of area median income","Property must be in eligible rural area","Administered by: US Dept of Agriculture"],
          },
        ],
      },
      {
        id: "underwriting", emoji: "üî¢", title: "Underwriting & Income", color: "#1a2a3a", accent: "#4ad4ff",
        items: [
          {
            title: "The 4 C's of Credit",
            mnemonic: "Credit, Capacity, Capital, Collateral",
            facts: ["1. Credit History: FICO score, payment history, derogatory marks","2. Capacity: Ability to repay ‚Äî income vs. debt (DTI)","3. Capital: Assets, savings, reserves","4. Collateral: Property value (LTV ratio)","FICO range: 300‚Äì850","Min score conventional: 620‚Äì640 typically"],
          },
          {
            title: "DTI Ratios ‚Äî Front & Back",
            mnemonic: "Front = housing only. Back = ALL debts. Both √∑ gross monthly income.",
            facts: ["Front-end: PITI √∑ Gross Monthly Income","PITI = Principal, Interest, Taxes, Insurance","Back-end: (PITI + all debts) √∑ Gross Monthly Income","Conventional: 28% front / 36% back","FHA: 31% front / 43% back","VA: No front-end, 41% back-end","USDA: 29% front / 41% back","QM rule: Max 43% DTI"],
          },
          {
            title: "Income Calculations",
            mnemonic: "Self-employed = 2 years tax returns √∑ 24 months",
            facts: ["W-2 employee: Base salary from pay stub + W-2","Overtime/bonus: 2-year average if consistent","Self-employed: 2 years returns, net + add-backs √∑ 24","Commission: 2-year average","Rental income: 75% of gross rent (vacancy factor)","Social Security: Grossed up 125% (non-taxable)","Child support/alimony: 3 years continuance required"],
          },
          {
            title: "LTV & CLTV",
            mnemonic: "LTV = Loan √∑ Value. CLTV = all loans √∑ Value.",
            facts: ["LTV = Loan Amount √∑ lower of appraised value or purchase price","CLTV = (1st + 2nd mortgage) √∑ Value","80% LTV = 20% equity = no PMI threshold","97% LTV = 3% down (HomeReady programs)","Appraisal form: URAR Form 1004"],
          },
        ],
      },
      {
        id: "regulations", emoji: "üìú", title: "Key Regulations & Numbers", color: "#2a1a1a", accent: "#ff7a4a",
        items: [
          {
            title: "Critical Dollar Amounts",
            mnemonic: "Memorize these or lose points!",
            facts: ["HOEPA High Cost: APR > 6.5% above APOR (1st lien)","HOEPA Points & Fees: > 5% of loan amount","RESPA Section 10 escrow cushion: 2 months max","PMI auto-cancel: 78% LTV (22% equity)","Section 8 penalty: Up to $10,000 + 1 year prison"],
          },
          {
            title: "Qualified Mortgage (QM) Rules",
            mnemonic: "QM = Safe Harbor. 43% DTI. No bad features.",
            facts: ["QM requires: Verify Ability to Repay (ATR)","Max DTI: 43%","Max loan term: 30 years","No negative amortization","No interest-only periods","No balloon payments (except rural/small creditor)","Points and fees: Max 3% of loan amount"],
          },
          {
            title: "Dodd-Frank 2010",
            mnemonic: "Dodd-Frank July 21, 2010 = created CFPB",
            facts: ["Signed: July 21, 2010","Created: CFPB (Consumer Financial Protection Bureau)","CFPB consolidated protection from 7 agencies","MLO compensation: Cannot be based on loan terms (Reg Z)","Dual compensation: Cannot receive from both lender and borrower","Steering: Cannot push to higher-cost loan if lower available"],
          },
          {
            title: "Privacy Laws",
            mnemonic: "GLB = Give Borrowers annual Privacy Notice",
            facts: ["Gramm-Leach-Bliley (GLB): Annual privacy notice required","Right to opt out of sharing with non-affiliated third parties","Red Flags Rule: Must have identity theft detection program","FACTA: Consumers get free annual credit report","FCRA: Governs credit reporting and adverse action notices"],
          },
        ],
      },
      {
        id: "mortgage_types", emoji: "üí∞", title: "Mortgage Products", color: "#1a3a3a", accent: "#4affee",
        items: [
          {
            title: "ARM Loans ‚Äî Index + Margin + Caps",
            mnemonic: "5/1 ARM = Fixed 5 years, adjusts every 1 year after",
            facts: ["Index: Benchmark rate (SOFR, CMT) ‚Äî the base","Margin: Lender profit added to index ‚Äî fixed throughout","Fully Indexed Rate = Index + Margin","2/2/5 ARM: First adjust max 2%, each max 2%, lifetime max 5%","Teaser rate: Below-market initial rate"],
          },
          {
            title: "Risky Loan Features",
            mnemonic: "Neg Am = BAD. Balloon = RISKY. Prepay Penalty = COSTLY.",
            facts: ["Negative amortization: Payment < interest = balance INCREASES","Balloon: Large final payment (e.g. 5/25 balloon)","Hard prepayment penalty: Applies to any prepayment","Soft prepayment penalty: Refinance only","Interest-only: Pay interest only, then fully amortize","3-2-1 buydown: Rate reduced 3%, 2%, 1% first 3 years"],
          },
          {
            title: "HELOCs & Second Mortgages",
            mnemonic: "HELOC = Credit card secured by your home",
            facts: ["HELOC: Home Equity Line of Credit ‚Äî revolving credit","Draw period: Typically 10 years","Repayment period: Typically 20 years","Piggyback 80/10/10: 80% 1st, 10% 2nd, 10% down ‚Äî avoids PMI"],
          },
          {
            title: "Reverse Mortgages ‚Äî HECM",
            mnemonic: "HECM = HUD-insured reverse mortgage. Must be 62+.",
            facts: ["HECM: Home Equity Conversion Mortgage (FHA insured)","Age requirement: 62 or older","No monthly payment required by borrower","Repayment: Sale, death, moving out, or 12-month non-occupancy","HUD-approved counseling REQUIRED before closing","MIP: 2% upfront + 0.5% annual"],
          },
        ],
      },
      {
        id: "closing", emoji: "üîë", title: "Closing & Title", color: "#2a1a3a", accent: "#c44aff",
        items: [
          {
            title: "Title Insurance",
            mnemonic: "Owner pays once, protects forever",
            facts: ["Lender's title policy: Protects lender ‚Äî required for most loans","Owner's title policy: Protects buyer ‚Äî optional but recommended","Chain of title: History of property ownership","Cloud on title: Any claim or lien affecting clear title","Quiet title action: Court action to clear title dispute"],
          },
          {
            title: "Deed Types ‚Äî Most to Least Protection",
            mnemonic: "General = Most protection. Quitclaim = Least protection.",
            facts: ["General Warranty Deed: Warrants title against ALL claims","Special Warranty Deed: Warrants claims during grantor's ownership only","Bargain and Sale Deed: No warranties (common in foreclosures)","Quitclaim Deed: No warranties ‚Äî conveys whatever interest grantor has","Deed of Trust: 3 parties ‚Äî trustor, trustee, beneficiary"],
          },
          {
            title: "Escrow & Closing Costs",
            mnemonic: "PITI = Principal, Interest, Taxes, Insurance ‚Äî goes into escrow monthly",
            facts: ["Escrow: Holds funds for taxes and insurance","Initial escrow deposit: Up to 2 months cushion allowed","Origination charges: Zero tolerance ‚Äî cannot increase","Recording fees: Zero tolerance","Proration: Dividing costs between buyer and seller at closing"],
          },
        ],
      },
      {
        id: "ethics", emoji: "‚ö†Ô∏è", title: "Ethics, Fraud & BSA/AML", color: "#2a1a10", accent: "#ff6b35",
        items: [
          {
            title: "Mortgage Fraud Types ‚Äî EXAM FAVORITE",
            mnemonic: "FISA: Flipping, Identity, Straw buyer, Appraisal",
            facts: [
              "Occupancy fraud: Claiming primary residence when it's investment property",
              "Income fraud: Inflating or fabricating income on application",
              "Appraisal fraud: Inflating property value ‚Äî MLO cannot pressure appraiser",
              "Straw buyer: Using another person's name/credit to obtain loan",
              "Property flipping fraud: Rapid resale with artificially inflated appraisal",
              "Air loans: Loans on non-existent properties",
              "Dual contracts: Two purchase contracts ‚Äî one real, one inflated for lender",
              "Chunking: Convincing investor to buy multiple properties without disclosing",
              "Fraud for property: Borrower misrepresents info to get loan",
              "Fraud for profit: Industry insider scheme for financial gain ‚Äî more serious",
            ],
          },
          {
            title: "MLO Ethics Rules",
            mnemonic: "SAME: Steering, Anti-churning, Material disclosure, Ethics first",
            facts: [
              "Cannot steer borrower to higher-cost loan if they qualify for better",
              "Cannot churn loans: repeated refinancing that benefits MLO not borrower",
              "Must disclose all fees, conflicts of interest, and loan terms accurately",
              "Cannot accept undisclosed gifts, kickbacks, or referral fees",
              "Cannot discourage borrower from seeking outside advice",
              "Must treat all applicants fairly ‚Äî no disparate treatment",
              "Fiduciary duty: Act in best interest of borrower",
              "Must report suspicious activity ‚Äî cannot tip off subject of SAR",
            ],
          },
          {
            title: "BSA / AML ‚Äî Bank Secrecy Act",
            mnemonic: "BSA = Big Suspicious Activity reports",
            facts: [
              "BSA: Requires financial institutions to detect and deter money laundering",
              "SAR (Suspicious Activity Report): File if suspicious activity ‚â• $5,000",
              "CTR (Currency Transaction Report): File for cash transactions > $10,000",
              "Structuring: Intentionally breaking up cash to avoid CTR = illegal",
              "USA PATRIOT Act: Requires Customer Identification Program (CIP)",
              "CIP requires: Name, DOB, address, ID number (SSN, passport, alien ID)",
              "FinCEN: Financial Crimes Enforcement Network ‚Äî receives BSA reports",
              "Red flags: Unexplained cash, multiple properties, inconsistent income",
              "Must NOT tip off the subject of a SAR filing",
            ],
          },
          {
            title: "UDAP / UDAAP",
            mnemonic: "UDAAP = Unfair, Deceptive, Abusive Acts or Practices",
            facts: [
              "UDAP: FTC authority ‚Äî Unfair or Deceptive Acts or Practices",
              "UDAAP: CFPB authority (adds 'Abusive') ‚Äî broader post-Dodd-Frank",
              "Unfair: Causes substantial injury, not avoidable, harm outweighs benefit",
              "Deceptive: Misleads reasonable consumer ‚Äî even technically true ads",
              "Abusive: Exploits lack of understanding OR consumer's reliance on MLO",
              "Reg Z Advertising: Cannot advertise teaser rate without full disclosure",
              "Trigger terms: If ad mentions rate/payment/down ‚Äî must disclose all terms",
            ],
          },
        ],
      },
      {
        id: "math", emoji: "üî¢", title: "Mortgage Math", color: "#102a1a", accent: "#50fa7b",
        items: [
          {
            title: "DTI Calculation",
            mnemonic: "Front = Housing √∑ Gross. Back = All Debts √∑ Gross.",
            facts: [
              "Front-end DTI = PITI √∑ Gross Monthly Income √ó 100",
              "Example: PITI $1,500 / Income $5,000 = 30% front-end",
              "Back-end DTI = (PITI + all monthly debts) √∑ Gross Monthly Income √ó 100",
              "Example: PITI $1,500 + debts $500 / Income $5,000 = 40% back-end",
              "Gross income = before taxes ‚Äî NOT net take-home",
              "Include: car loans, student loans, credit card minimums, child support",
              "Exclude: utilities, insurance, groceries, cell phone",
            ],
          },
          {
            title: "LTV & Down Payment Math",
            mnemonic: "LTV = Loan √∑ Value. Down = Value √ó (1 - LTV)",
            facts: [
              "LTV = Loan Amount √∑ Lesser of Purchase Price or Appraised Value √ó 100",
              "Example: $180,000 loan / $200,000 value = 90% LTV",
              "Down payment = Purchase Price √ó down payment %",
              "Example: $200,000 √ó 3.5% = $7,000 FHA down payment",
              "If appraised < purchase price: use appraised value for LTV",
              "PMI required if LTV > 80% on conventional loans",
              "To avoid PMI: need 20% down ($40,000 on $200,000 home)",
            ],
          },
          {
            title: "Points & Rate Buydown",
            mnemonic: "1 point = 1% of loan. Buys rate down ~0.25%",
            facts: [
              "1 discount point = 1% of loan amount paid upfront",
              "Example: 1 point on $200,000 loan = $2,000 upfront cost",
              "Typically buys rate down by 0.125% to 0.25%",
              "Break-even: Points cost √∑ monthly savings = months to recoup",
              "Example: $2,000 cost / $50 monthly savings = 40 months break-even",
              "Origination points: Lender fee ‚Äî not same as discount points",
              "2-1 buydown: Rate 2% lower year 1, 1% lower year 2, full rate year 3",
            ],
          },
          {
            title: "Self-Employed Income Calculation",
            mnemonic: "2 years returns √∑ 24 = monthly qualifying income",
            facts: [
              "Use 2 years of federal tax returns (1040 + Schedule C/E/K-1)",
              "Add back: depreciation, depletion, non-recurring losses",
              "Self-employed = owns 25% or more of business",
              "Formula: (Year 1 net + Year 2 net + add-backs) √∑ 24",
              "If income declining year over year: use lower year only",
              "Business must show 2-year history of self-employment",
              "YTD P&L may be required if > 10% variance from prior year",
            ],
          },
        ],
      },
      {
        id: "market", emoji: "üè¶", title: "Mortgage Market & Secondary Market", color: "#1a1a3a", accent: "#bd93f9",
        items: [
          {
            title: "Primary vs. Secondary Market",
            mnemonic: "Primary = originate. Secondary = buy/sell loans.",
            facts: [
              "Primary market: Where lenders originate loans directly to borrowers",
              "Secondary market: Where lenders sell loans to investors",
              "Selling loans frees up capital to originate more loans",
              "Fannie Mae (FNMA): GSE ‚Äî buys conforming conventional loans",
              "Freddie Mac (FHLMC): GSE ‚Äî buys conforming conventional loans",
              "Ginnie Mae (GNMA): Government ‚Äî backs FHA, VA, USDA loan pools",
              "MBS (Mortgage-Backed Securities): Pools of loans sold to investors",
              "Servicer: Collects payments ‚Äî may differ from original lender",
              "Servicing transfer: Borrower must be notified 15 days before transfer",
            ],
          },
          {
            title: "Mortgage Terminology ‚Äî Key Terms",
            mnemonic: "Know these or get tripped up on exam day",
            facts: [
              "Subordination: Junior lien holder agrees to remain in lower priority",
              "Assumable loan: Buyer takes over seller's existing mortgage",
              "Acceleration clause: Entire loan due immediately on default",
              "Due-on-sale clause: Loan must be paid off when property is sold",
              "Alienation clause: Same as due-on-sale ‚Äî prevents assumption",
              "Deficiency judgment: Lender sues for remaining balance after foreclosure",
              "Recourse loan: Lender can pursue borrower's assets after foreclosure",
              "Non-recourse: Lender limited to collateral only",
              "Yield Spread Premium (YSP): Rebate to broker for higher-rate loan",
            ],
          },
          {
            title: "Appraisal Rules",
            mnemonic: "MLO cannot pressure appraiser ‚Äî EVER",
            facts: [
              "USPAP: Uniform Standards of Professional Appraisal Practice",
              "URAR (Form 1004): Standard appraisal form for single-family homes",
              "AIR (Appraiser Independence Requirements): Prohibits pressure on appraiser",
              "MLO cannot: suggest value, threaten appraiser, withhold payment if low",
              "Desk review: Brief office review of existing appraisal",
              "Field review: Appraiser visits property to verify",
              "BPO (Broker Price Opinion): Not an appraisal ‚Äî lower cost estimate",
              "AMC (Appraisal Management Company): Third-party ordering appraisals",
            ],
          },
          {
            title: "Exam Format ‚Äî Know This!",
            mnemonic: "125 questions, 190 minutes, 75% to pass",
            facts: [
              "Total questions: 125 (115 scored + 10 unscored pretest)",
              "Time allowed: 190 minutes (3 hrs 10 min)",
              "Passing score: 75% = 86 correct out of 115 scored",
              "Exam fee: $110 per attempt",
              "Wait periods: 3 fails ‚Üí 30-day wait ‚Üí 3 more fails ‚Üí 180-day wait",
              "Test content: Loan Origination 27%, Fed Laws 24%, Mortgage Knowledge 20%, Ethics 18%, State Content 11%",
              "ID required: Government-issued photo ID",
              "Cannot bring: calculators, notes, phones",
              "Prometric testing centers nationwide",
            ],
          },
        ],
      },
    ];

    const quickFacts = [
      { q: "SAFE Act signed", a: "July 30, 2008" },
      { q: "Pre-licensing hours", a: "20 hours total" },
      { q: "CE hours annual", a: "8 hours" },
      { q: "SAFE test passing score", a: "75%" },
      { q: "SAFE exam questions", a: "125 total (115 scored)" },
      { q: "SAFE exam time limit", a: "190 minutes" },
      { q: "Loan Estimate delivery", a: "3 business days after application" },
      { q: "Closing Disclosure delivery", a: "3 business days before closing" },
      { q: "Right of rescission", a: "3 business days (refi only)" },
      { q: "Extended rescission (no disclosure)", a: "3 years" },
      { q: "FHA min down payment", a: "3.5% (580+ score)" },
      { q: "FHA upfront MIP", a: "1.75%" },
      { q: "FHA annual MIP (typical)", a: "0.55% (30-yr, <5% down)" },
      { q: "VA down payment", a: "0%" },
      { q: "VA funding fee (1st use, 0% down)", a: "2.15%" },
      { q: "USDA down payment", a: "0%" },
      { q: "USDA upfront guarantee fee", a: "1%" },
      { q: "USDA annual fee", a: "0.35%" },
      { q: "Conforming loan limit 2026", a: "$832,750" },
      { q: "High-cost area ceiling 2026", a: "$1,249,125" },
      { q: "PMI auto-cancel LTV", a: "78%" },
      { q: "Max QM DTI", a: "43%" },
      { q: "RESPA escrow cushion max", a: "2 months" },
      { q: "RESPA escrow surplus refund trigger", a: "$50 overage" },
      { q: "Adverse action notice", a: "30 days" },
      { q: "ECOA recordkeeping", a: "25 months" },
      { q: "Reverse mortgage min age", a: "62 years old" },
      { q: "HECM upfront MIP", a: "2%" },
      { q: "HECM annual MIP", a: "0.5%" },
      { q: "Temporary MLO authority", a: "120 days" },
      { q: "SAR filing threshold", a: "$5,000 suspicious activity" },
      { q: "CTR filing threshold", a: "$10,000 cash transaction" },
      { q: "HMDA asset threshold 2026", a: "$59 million" },
      { q: "Servicing transfer notice", a: "15 days before effective date" },
      { q: "HOEPA high-cost threshold (1st lien)", a: "APR > 6.5% above APOR" },
      { q: "QM max points & fees", a: "3% of loan amount" },
    ];

    // ‚îÄ‚îÄ Voice Settings Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function VoiceSettingsPanel({ voiceSettings, setVoiceSettings }) {
      const [open, setOpen] = useState(false);
      return (
        <div style={{ position: "relative" }}>
          <button onClick={() => setOpen(p => !p)} style={{ background: open ? "#4a9eff22" : "#ffffff11", border: `1px solid ${open ? "#4a9eff66" : "#ffffff22"}`, borderRadius: "8px", padding: "8px 14px", color: open ? "#4a9eff" : "#aaa", fontSize: "13px", display: "flex", alignItems: "center", gap: "6px" }}>
            ‚öôÔ∏è Voice Options
          </button>
          {open && (
            <div style={{ position: "absolute", top: "44px", right: 0, background: "#1a1a2e", border: "1px solid #4a9eff44", borderRadius: "12px", padding: "18px", zIndex: 200, minWidth: "280px", boxShadow: "0 8px 32px rgba(0,0,0,0.7)" }}>
              <div style={{ fontSize: "13px", color: "#4a9eff", fontWeight: 700, marginBottom: "14px", letterSpacing: "1px" }}>üéôÔ∏è GOOGLE TTS SETTINGS</div>

              {/* Gender */}
              <div style={{ marginBottom: "14px" }}>
                <div style={{ fontSize: "11px", color: "#888", marginBottom: "6px", letterSpacing: "1px" }}>GENDER</div>
                <div style={{ display: "flex", gap: "6px" }}>
                  {["female", "male", "any"].map(g => (
                    <button key={g} onClick={() => setVoiceSettings(p => ({ ...p, gender: g, voice: GCP_VOICES[g][0].id }))}
                      style={{ flex: 1, padding: "7px 0", borderRadius: "6px", border: `1px solid ${voiceSettings.gender === g ? "#4a9eff88" : "#333"}`, background: voiceSettings.gender === g ? "#4a9eff22" : "transparent", color: voiceSettings.gender === g ? "#4a9eff" : "#777", fontSize: "12px", cursor: "pointer" }}>
                      {g === "female" ? "‚ôÄ Female" : g === "male" ? "‚ôÇ Male" : "‚ö° Any"}
                    </button>
                  ))}
                </div>
              </div>

              {/* Voice picker */}
              <div style={{ marginBottom: "14px" }}>
                <div style={{ fontSize: "11px", color: "#888", marginBottom: "6px", letterSpacing: "1px" }}>VOICE</div>
                <div style={{ display: "grid", gap: "5px" }}>
                  {GCP_VOICES[voiceSettings.gender].map(v => (
                    <button key={v.id} onClick={() => setVoiceSettings(p => ({ ...p, voice: v.id }))}
                      style={{ padding: "8px 12px", borderRadius: "6px", border: `1px solid ${voiceSettings.voice === v.id ? "#4a9eff88" : "#2a2a3a"}`, background: voiceSettings.voice === v.id ? "#4a9eff22" : "#111120", color: voiceSettings.voice === v.id ? "#4a9eff" : "#888", fontSize: "12px", cursor: "pointer", textAlign: "left" }}>
                      {voiceSettings.voice === v.id ? "‚úì " : ""}{v.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Speed */}
              <div>
                <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "6px" }}>
                  <span style={{ fontSize: "11px", color: "#888", letterSpacing: "1px" }}>SPEED</span>
                  <span style={{ fontSize: "12px", color: "#4a9eff" }}>{voiceSettings.speed}x</span>
                </div>
                <input type="range" min="0.6" max="1.5" step="0.05" value={voiceSettings.speed}
                  onChange={e => setVoiceSettings(p => ({ ...p, speed: parseFloat(e.target.value) }))}
                  style={{ width: "100%", accentColor: "#4a9eff" }} />
                <div style={{ display: "flex", justifyContent: "space-between", fontSize: "10px", color: "#555" }}>
                  <span>Slow</span><span>Normal</span><span>Fast</span>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ‚îÄ‚îÄ Google Cloud TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const GCP_API_KEY = "AIzaSyA4gtzTwXeyhhtsxpXzxvID92yi9AaiekY";

    // Google WaveNet voices ‚Äî very natural US English
    const GCP_VOICES = {
      female: [
        { id: "en-US-Journey-F",    label: "Journey F ‚Äî conversational ‚≠ê" },
        { id: "en-US-Neural2-F",    label: "Neural2 F ‚Äî clear, natural" },
        { id: "en-US-Wavenet-F",    label: "WaveNet F ‚Äî warm" },
        { id: "en-US-Neural2-C",    label: "Neural2 C ‚Äî soft" },
      ],
      male: [
        { id: "en-US-Journey-D",    label: "Journey D ‚Äî conversational ‚≠ê" },
        { id: "en-US-Neural2-D",    label: "Neural2 D ‚Äî deep, natural" },
        { id: "en-US-Wavenet-D",    label: "WaveNet D ‚Äî strong" },
        { id: "en-US-Neural2-A",    label: "Neural2 A ‚Äî smooth" },
      ],
      any: [
        { id: "en-US-Journey-F",    label: "Journey F (female) ‚≠ê" },
        { id: "en-US-Journey-D",    label: "Journey D (male) ‚≠ê" },
        { id: "en-US-Neural2-F",    label: "Neural2 F (female)" },
        { id: "en-US-Neural2-D",    label: "Neural2 D (male)" },
        { id: "en-US-Wavenet-F",    label: "WaveNet F (female)" },
        { id: "en-US-Wavenet-D",    label: "WaveNet D (male)" },
      ],
    };

    function App() {
      const [activeSection, setActiveSection] = useState(null);
      const [revealed, setRevealed] = useState({});
      const [activeTab, setActiveTab] = useState("sections");
      const [speaking, setSpeaking] = useState(false);
      const [paused, setPaused] = useState(false);
      const [loading, setLoading] = useState(false);
      const [currentLabel, setCurrentLabel] = useState("");
      const [highlightedFact, setHighlightedFact] = useState(null);
      const [voiceSettings, setVoiceSettings] = useState({ gender: "female", voice: "en-US-Journey-F", speed: 1.0 });

      const audioRef = useRef(null);
      const playingRef = useRef(false);
      const stoppedRef = useRef(false);
      const pausedRef = useRef(false);

      // ‚îÄ‚îÄ Normalize abbreviations for natural TTS pronunciation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const normalizeTTS = (text) => {
        // Pattern: phonetic-acronym, Full Name,
        // Lowercase acronym = TTS reads as a word (not letter-by-letter)
        const replacements = [
          // Word-like acronyms ‚Äî TTS already handles naturally, keep as-is
          [/\bTRID\b/g,    "Trid"],
          [/\bRESPA\b/g,   "Respa"],
          [/\bTILA\b/g,    "Tyla"],
          [/\bHOEPA\b/g,   "Hoepa"],
          [/\bHELOC\b/g,   "Heelock"],
          [/\bFHA\b/g,     "F H A"],
          [/\bHUD\b/g,     "Hud"],
          [/\bVA\b/g,      "V A"],
          [/\bARMs\b/g,    "arm loans"],
          [/\bARM\b/g,     "arm"],

          // Acronym spoken as word + full expansion
          [/\bSSN\b/g,     "S S N, Social Security Number,"],
          [/\bMLOs\b/g,    "M L Os, mortgage loan originators,"],
          [/\bMLO\b/g,     "M L O, mortgage loan originator,"],
          [/\bNMLS\b/g,    "N M L S, Nationwide Multistate Licensing System,"],
          [/\bCFPB\b/g,    "C F P B, Consumer Financial Protection Bureau,"],
          [/\bHMDA\b/g,    "Hmda, Home Mortgage Disclosure Act,"],
          [/\bECOA\b/g,    "Ecoa, Equal Credit Opportunity Act,"],
          [/\bHECM\b/g,    "Heckm, Home Equity Conversion Mortgage,"],
          [/\bUSDA\b/g,    "Usda, US Department of Agriculture,"],
          [/\bFNMA\b/g,    "Fannie Mae,"],
          [/\bFHLMC\b/g,   "Freddie Mac,"],
          [/\bGNMA\b/g,    "Ginnie Mae,"],
          [/\bFHFA\b/g,    "F H F A, Federal Housing Finance Agency,"],
          [/\bDTI\b/g,     "D T I, debt-to-income ratio,"],
          [/\bCLTV\b/g,    "C L T V, combined loan-to-value,"],
          [/\bLTV\b/g,     "L T V, loan-to-value,"],
          [/\bPMI\b/g,     "P M I, private mortgage insurance,"],
          [/\bMIP\b/g,     "M I P, mortgage insurance premium,"],
          [/\bMBS\b/g,     "M B S, mortgage-backed securities,"],
          [/\bGSEs\b/g,    "G S Es, government-sponsored enterprises,"],
          [/\bGSE\b/g,     "G S E, government-sponsored enterprise,"],
          [/\bAPR\b/g,     "A P R, annual percentage rate,"],
          [/\bATR\b/g,     "A T R, ability to repay,"],
          [/\bQM\b/g,      "Q M, qualified mortgage,"],
          [/\bPITI\b/g,    "P I T I, principal interest taxes and insurance,"],
          [/\bCOE\b/g,     "C O E, Certificate of Eligibility,"],
          [/\bGLB\b/g,     "G L B, Gramm-Leach-Bliley Act,"],
          [/\bFCRA\b/g,    "F C R A, Fair Credit Reporting Act,"],
          [/\bFACTA\b/g,   "Facta, Fair and Accurate Credit Transactions Act,"],
          [/\bCRA\b/g,     "C R A, Community Reinvestment Act,"],
          [/\bLAR\b/g,     "L A R, Loan Application Register,"],
          [/\bSAR\b/g,     "S A R, Suspicious Activity Report,"],
          [/\bCTR\b/g,     "C T R, Currency Transaction Report,"],
          [/\bBSA\b/g,     "B S A, Bank Secrecy Act,"],
          [/\bAML\b/g,     "A M L, anti-money laundering,"],
          [/\bUDAAP\b/g,   "Udaap, unfair deceptive or abusive acts or practices,"],
          [/\bUDAP\b/g,    "Udap, unfair or deceptive acts or practices,"],
          [/\bCIP\b/g,     "C I P, Customer Identification Program,"],
          [/\bFinCEN\b/g,  "Fincen, Financial Crimes Enforcement Network,"],
          [/\bUSPAP\b/g,   "Uspap, Uniform Standards of Professional Appraisal Practice,"],
          [/\bURAR\b/g,    "U R A R, Uniform Residential Appraisal Report,"],
          [/\bAMC\b/g,     "A M C, appraisal management company,"],
          [/\bBPO\b/g,     "B P O, broker price opinion,"],
          [/\bAIR\b/g,     "A I R, Appraiser Independence Requirements,"],
          [/\bAFBA\b/g,    "A F B A, affiliated business arrangement,"],
          [/\bIRRRL\b/g,   "Irrrl, interest rate reduction refinance loan,"],
          [/\bCE\b/g,      "C E, continuing education,"],
          [/\bW-2\b/g,     "W 2"],
          [/\b1040\b/g,    "ten forty"],
          // Symbols
          [/‚â•/g,   " or more "],
          [/‚â§/g,   " or less "],
          [/>/g,   " greater than "],
          [/</g,   " less than "],
          [/√∑/g,   " divided by "],
          [/√ó/g,   " times "],
          [/\$/g,  " dollar "],
          [/%/g,   " percent "],
          [/&/g,   " and "],
          [/‚Äî/g,   ". "],
          [/\//g,  " or "],
        ];

        let result = text;
        for (const [pattern, replacement] of replacements) {
          result = result.replace(pattern, replacement);
        }
        return result;
      };

      // Fetch TTS audio from Google Cloud and return blob URL
      const fetchTTS = async (text, voiceName, speed) => {
        const normalizedText = normalizeTTS(text);
        const res = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GCP_API_KEY}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            input: { text: normalizedText },
            voice: { languageCode: "en-US", name: voiceName },
            audioConfig: { audioEncoding: "MP3", speakingRate: speed },
          }),
        });
        if (!res.ok) { const err = await res.json(); throw new Error(err.error?.message || "TTS API error"); }
        const data = await res.json();
        const bytes = Uint8Array.from(atob(data.audioContent), c => c.charCodeAt(0));
        const blob = new Blob([bytes], { type: "audio/mp3" });
        return URL.createObjectURL(blob);
      };

      const stopSpeaking = () => {
        stoppedRef.current = true;
        pausedRef.current = false;
        playingRef.current = false;
        if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
        setSpeaking(false); setPaused(false); setLoading(false);
        setCurrentLabel(""); setHighlightedFact(null);
      };

      const pauseResume = () => {
        const audio = audioRef.current;
        if (!audio) return;
        if (pausedRef.current) {
          // Resume
          audio.play();
          pausedRef.current = false;
          setPaused(false);
        } else {
          // Pause
          audio.pause();
          pausedRef.current = true;
          setPaused(true);
        }
      };

      // Play a queue of { text, sectionId, itemIdx, factIdx } segments sequentially
      const playQueue = async (queue, label) => {
        stoppedRef.current = false;
        pausedRef.current = false;
        playingRef.current = true;
        setSpeaking(true); setPaused(false); setLoading(true); setCurrentLabel(label);

        for (let i = 0; i < queue.length; i++) {
          if (stoppedRef.current) break;

          // Wait while paused before fetching next segment
          while (pausedRef.current && !stoppedRef.current) {
            await new Promise(r => setTimeout(r, 100));
          }
          if (stoppedRef.current) break;

          const seg = queue[i];
          try {
            const url = await fetchTTS(seg.text, voiceSettings.voice, voiceSettings.speed);
            if (stoppedRef.current) { URL.revokeObjectURL(url); break; }
            setLoading(false);
            if (seg.factIdx !== undefined) setHighlightedFact({ sectionId: seg.sectionId, itemIdx: seg.itemIdx, factIdx: seg.factIdx });
            else setHighlightedFact(null);

            await new Promise((resolve, reject) => {
              const audio = new Audio(url);
              audioRef.current = audio;
              audio.onended = () => { URL.revokeObjectURL(url); resolve(); };
              audio.onerror = () => { URL.revokeObjectURL(url); reject(); };
              audio.play();
            });

            // After audio ends, clear the ref
            audioRef.current = null;
          } catch(e) {
            if (!stoppedRef.current) { alert("TTS Error: " + e.message); stopSpeaking(); break; }
          }
        }
        if (!stoppedRef.current) {
          setSpeaking(false); setLoading(false); setCurrentLabel(""); setHighlightedFact(null);
          playingRef.current = false; pausedRef.current = false;
        }
      };

      const speak = (text, label) => {
        stopSpeaking();
        setTimeout(() => playQueue([{ text }], label), 50);
      };

      const speakSection = (section) => {
        stopSpeaking();
        const queue = [];
        section.items.forEach((item, itemIdx) => {
          queue.push({ text: `${item.title}. Memory trick: ${item.mnemonic}.` });
          item.facts.forEach((fact, factIdx) => {
            queue.push({ text: fact, sectionId: section.id, itemIdx, factIdx });
          });
        });
        setTimeout(() => playQueue(queue, section.title), 50);
      };

      const speakItem = (item, sectionId, itemIdx) => {
        stopSpeaking();
        const queue = [{ text: `${item.title}. Memory trick: ${item.mnemonic}.` }];
        item.facts.forEach((fact, factIdx) => {
          queue.push({ text: fact, sectionId, itemIdx, factIdx });
        });
        setTimeout(() => playQueue(queue, item.title), 50);
      };

      // Convert flashcard key into a natural exam question
      const toQuestion = (q) => {
        const map = {
          "SAFE Act signed":               "When was the SAFE Act signed into law?",
          "Pre-licensing hours":           "How many pre-licensing education hours are required?",
          "CE hours annual":               "How many continuing education hours are required each year?",
          "SAFE test passing score":       "What is the passing score for the SAFE exam?",
          "SAFE exam questions":           "How many questions are on the SAFE exam?",
          "SAFE exam time limit":          "How much time is allowed for the SAFE exam?",
          "Loan Estimate delivery":        "When must the Loan Estimate be delivered to the borrower?",
          "Closing Disclosure delivery":   "When must the Closing Disclosure be delivered before closing?",
          "Right of rescission":           "How long is the right of rescission period?",
          "Extended rescission (no disclosure)": "How long is the extended right of rescission when disclosures were not provided?",
          "FHA min down payment":          "What is the minimum down payment for an FHA loan?",
          "FHA upfront MIP":               "What is the FHA upfront mortgage insurance premium rate?",
          "FHA annual MIP (typical)":      "What is the typical FHA annual mortgage insurance premium for a 30-year loan?",
          "VA down payment":               "What is the required down payment for a VA loan?",
          "VA funding fee (1st use, 0% down)": "What is the VA funding fee for first-time use with no down payment?",
          "USDA down payment":             "What is the required down payment for a USDA loan?",
          "USDA upfront guarantee fee":    "What is the USDA upfront guarantee fee?",
          "USDA annual fee":               "What is the USDA annual guarantee fee?",
          "Conforming loan limit 2026":    "What is the conforming loan limit for 2026?",
          "High-cost area ceiling 2026":   "What is the high-cost area loan limit ceiling for 2026?",
          "PMI auto-cancel LTV":           "At what loan-to-value ratio does PMI automatically cancel?",
          "Max QM DTI":                    "What is the maximum debt-to-income ratio for a Qualified Mortgage?",
          "RESPA escrow cushion max":      "What is the maximum escrow cushion allowed under RESPA?",
          "RESPA escrow surplus refund trigger": "What is the minimum escrow surplus that triggers a required refund?",
          "Adverse action notice":         "How many days does a lender have to send an adverse action notice?",
          "ECOA recordkeeping":            "How long must lenders retain records under ECOA?",
          "Reverse mortgage min age":      "What is the minimum age to qualify for a reverse mortgage?",
          "HECM upfront MIP":              "What is the upfront mortgage insurance premium for a HECM reverse mortgage?",
          "HECM annual MIP":               "What is the annual mortgage insurance premium for a HECM reverse mortgage?",
          "Temporary MLO authority":       "How many days of temporary MLO authority are allowed under the SAFE Act?",
          "SAR filing threshold":          "At what dollar amount must a Suspicious Activity Report be filed?",
          "CTR filing threshold":          "At what dollar amount must a Currency Transaction Report be filed?",
          "HMDA asset threshold 2026":     "What is the HMDA asset exemption threshold for 2026?",
          "Servicing transfer notice":     "How far in advance must borrowers be notified of a loan servicing transfer?",
          "HOEPA high-cost threshold (1st lien)": "What is the APR threshold that triggers HOEPA high-cost classification for a first lien?",
          "QM max points & fees":          "What is the maximum points and fees allowed for a Qualified Mortgage?",
        };
        return map[q] || `What is the ${q}?`;
      };

      // Generate a short beep sound as a base64 WAV and return object URL
      const makeBeepUrl = () => {
        const sampleRate = 22050;
        const duration = 0.18;
        const freq = 880;
        const numSamples = Math.floor(sampleRate * duration);
        const buffer = new ArrayBuffer(44 + numSamples * 2);
        const view = new DataView(buffer);
        const writeStr = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
        writeStr(0, 'RIFF'); view.setUint32(4, 36 + numSamples * 2, true);
        writeStr(8, 'WAVE'); writeStr(12, 'fmt ');
        view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
        view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true); view.setUint16(34, 16, true);
        writeStr(36, 'data'); view.setUint32(40, numSamples * 2, true);
        for (let i = 0; i < numSamples; i++) {
          const t = i / sampleRate;
          const envelope = Math.min(1, t * 40) * Math.max(0, 1 - t / duration * 2);
          const sample = Math.sin(2 * Math.PI * freq * t) * envelope * 0.6 * 32767;
          view.setInt16(44 + i * 2, sample, true);
        }
        return URL.createObjectURL(new Blob([buffer], { type: 'audio/wav' }));
      };

      // Play beep then wait silently (total ~3 seconds pause)
      const playBeepPause = () => new Promise(resolve => {
        const url = makeBeepUrl();
        const audio = new Audio(url);
        audioRef.current = audio;
        audio.onended = () => {
          URL.revokeObjectURL(url);
          // After beep, wait ~2.8s of silence
          let elapsed = 0;
          const tick = setInterval(() => {
            if (stoppedRef.current) { clearInterval(tick); resolve(); return; }
            elapsed += 100;
            if (elapsed >= 2800) { clearInterval(tick); resolve(); }
          }, 100);
        };
        audio.play();
      });

      const speakFlashcard = async (fact) => {
        stopSpeaking();
        await new Promise(r => setTimeout(r, 60));
        stoppedRef.current = false;
        pausedRef.current = false;
        setSpeaking(true); setLoading(true); setCurrentLabel(fact.q);

        try {
          // 1. Fetch and play question
          const qText = toQuestion(fact.q);
          const qUrl = await fetchTTS(qText, voiceSettings.voice, voiceSettings.speed);
          if (stoppedRef.current) { URL.revokeObjectURL(qUrl); return; }
          setLoading(false);
          await new Promise((resolve, reject) => {
            const audio = new Audio(qUrl);
            audioRef.current = audio;
            audio.onended = () => { URL.revokeObjectURL(qUrl); resolve(); };
            audio.onerror = () => { URL.revokeObjectURL(qUrl); reject(); };
            audio.play();
          });
          audioRef.current = null;

          if (stoppedRef.current) return;

          // 2. Beep + ~3 sec pause
          await playBeepPause();
          if (stoppedRef.current) return;

          // 3. Fetch and play answer
          const aUrl = await fetchTTS("The answer is. " + fact.a, voiceSettings.voice, voiceSettings.speed);
          if (stoppedRef.current) { URL.revokeObjectURL(aUrl); return; }
          await new Promise((resolve, reject) => {
            const audio = new Audio(aUrl);
            audioRef.current = audio;
            audio.onended = () => { URL.revokeObjectURL(aUrl); resolve(); };
            audio.onerror = () => { URL.revokeObjectURL(aUrl); reject(); };
            audio.play();
          });
          audioRef.current = null;
        } catch(e) {
          if (!stoppedRef.current) console.error("Flashcard TTS error:", e);
        } finally {
          if (!stoppedRef.current) {
            setSpeaking(false); setLoading(false); setCurrentLabel("");
          }
        }
      };

      const speakAllFlashcards = async () => {
        stopSpeaking();
        await new Promise(r => setTimeout(r, 60));
        stoppedRef.current = false;
        pausedRef.current = false;
        setSpeaking(true); setLoading(true); setCurrentLabel("All Flashcards");

        for (let i = 0; i < quickFacts.length; i++) {
          if (stoppedRef.current) break;

          // Wait while paused
          while (pausedRef.current && !stoppedRef.current) {
            await new Promise(r => setTimeout(r, 100));
          }
          if (stoppedRef.current) break;

          const fact = quickFacts[i];
          setCurrentLabel(`Q${i + 1}: ${fact.q}`);

          try {
            // Question
            const qUrl = await fetchTTS(toQuestion(fact.q), voiceSettings.voice, voiceSettings.speed);
            if (stoppedRef.current) { URL.revokeObjectURL(qUrl); break; }
            setLoading(false);
            await new Promise((resolve, reject) => {
              const audio = new Audio(qUrl);
              audioRef.current = audio;
              audio.onended = () => { URL.revokeObjectURL(qUrl); resolve(); };
              audio.onerror = () => { URL.revokeObjectURL(qUrl); reject(); };
              audio.play();
            });
            audioRef.current = null;
            if (stoppedRef.current) break;

            // Beep + pause
            await playBeepPause();
            if (stoppedRef.current) break;

            // Answer
            const aUrl = await fetchTTS("The answer is. " + fact.a, voiceSettings.voice, voiceSettings.speed);
            if (stoppedRef.current) { URL.revokeObjectURL(aUrl); break; }
            await new Promise((resolve, reject) => {
              const audio = new Audio(aUrl);
              audioRef.current = audio;
              audio.onended = () => { URL.revokeObjectURL(aUrl); resolve(); };
              audio.onerror = () => { URL.revokeObjectURL(aUrl); reject(); };
              audio.play();
            });
            audioRef.current = null;

            // Short gap between cards
            await new Promise(r => setTimeout(r, 800));
          } catch(e) {
            if (!stoppedRef.current) console.error("Flashcard TTS error:", e);
          }
        }

        if (!stoppedRef.current) {
          setSpeaking(false); setLoading(false); setCurrentLabel("");
          playingRef.current = false;
        }
      };

      const speakCheatSheet = () => {
        speak([
          "Critical Numbers Cheat Sheet for 2026.",
          "20 hours, Pre-licensing education.",
          "8 hours, Annual CE.",
          "75 percent, SAFE exam passing score.",
          "3 business days, Loan Estimate delivery.",
          "3 business days before closing, Closing Disclosure.",
          "3.5 percent, FHA minimum down payment.",
          "1.75 percent, FHA upfront MIP.",
          "0.55 percent, FHA annual MIP for most 30-year borrowers.",
          "832,750 dollars, 2026 conforming loan limit.",
          "1,249,125 dollars, 2026 high-cost area ceiling.",
          "78 percent LTV, PMI auto-cancellation.",
          "43 percent, Maximum QM DTI.",
          "2 months, Maximum RESPA escrow cushion.",
          "30 days, ECOA adverse action notice.",
          "25 months, ECOA recordkeeping.",
          "62 years, Reverse mortgage minimum age.",
          "120 days, Temporary MLO authority.",
          "59 million dollars, HMDA asset exemption threshold for 2026.",
          "10,000 dollars plus 1 year, RESPA Section 8 penalty.",
          "3 years, Extended right of rescission.",
          "2 percent, HECM upfront MIP.",
        ].join(" "), "Cheat Sheet");
      };

      const toggleReveal = (idx) => setRevealed(p => ({ ...p, [idx]: !p[idx] }));
      const revealAll = () => { const a = {}; quickFacts.forEach((_, i) => a[i] = true); setRevealed(a); };

      const SpeakBtn = ({ onClick, label, small }) => (
        <button onClick={(e) => { e.stopPropagation(); speaking && currentLabel === label ? stopSpeaking() : onClick(); }}
          style={{
            background: speaking && currentLabel === label ? "#ff4a4a22" : "#ffffff11",
            border: `1px solid ${speaking && currentLabel === label ? "#ff4a4a66" : "#ffffff22"}`,
            borderRadius: "6px", padding: small ? "3px 8px" : "6px 12px",
            color: speaking && currentLabel === label ? "#ff4a4a" : "#aaa",
            fontSize: small ? "12px" : "13px", display: "flex", alignItems: "center", gap: "4px", flexShrink: 0,
          }}>
          {speaking && currentLabel === label ? "‚èπ" : "üîä"}
        </button>
      );

      return (
        <div style={{ minHeight: "100vh", background: "#0a0a0f", fontFamily: "Georgia, serif", color: "#e8e4d9" }}>

          {(speaking || loading) && (
            <div style={{ position: "fixed", top: 0, left: 0, right: 0, zIndex: 100, background: loading ? "#2a2a4a" : paused ? "#ff9a00" : "#4a9eff", padding: "8px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", fontSize: "13px", color: loading ? "#aaa" : "#000" }}>
              <span>{loading ? "‚è≥ Generating audio..." : paused ? "‚è∏ Paused" : "üîä Reading"}: <strong>{currentLabel}</strong></span>
              <div style={{ display: "flex", gap: "8px" }}>
                {!loading && <button onClick={pauseResume} style={{ background: "#00000022", border: "none", borderRadius: "4px", padding: "4px 14px", cursor: "pointer", color: "#000", fontSize: "13px", fontWeight: 700 }}>
                  {paused ? "‚ñ∂ Resume" : "‚è∏ Pause"}
                </button>}
                <button onClick={stopSpeaking} style={{ background: "#00000022", border: "none", borderRadius: "4px", padding: "4px 12px", cursor: "pointer", color: loading ? "#ccc" : "#000", fontSize: "13px" }}>‚èπ Stop</button>
              </div>
            </div>
          )}

          <div style={{ background: "linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)", padding: speaking ? "56px 24px 32px" : "40px 24px 32px", textAlign: "center", borderBottom: "2px solid #4a9eff33" }}>
            <div style={{ fontSize: "12px", letterSpacing: "4px", color: "#4a9eff", textTransform: "uppercase", marginBottom: "12px" }}>NMLS SAFE ACT EXAM</div>
            <h1 style={{ fontSize: "clamp(26px, 5vw, 46px)", fontWeight: 900, margin: "0 0 8px", background: "linear-gradient(90deg, #fff, #4a9eff, #fff)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>MUST-MEMORIZE GUIDE</h1>
            <p style={{ color: "#aaa", fontSize: "14px", margin: "0 0 24px" }}>ÏãúÌóò Ï†ÑÎÇ† ÏôÑÏ†Ñ Ï†ïÎ≥µ ‚Äî Key Facts + Memory Tricks + üîä Audio</p>
            <div style={{ display: "flex", justifyContent: "center", alignItems: "center", gap: "12px", flexWrap: "wrap" }}>
              {["sections", "flashcards"].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} style={{ padding: "10px 24px", borderRadius: "100px", border: activeTab === tab ? "2px solid #4a9eff" : "2px solid #333", background: activeTab === tab ? "#4a9eff22" : "transparent", color: activeTab === tab ? "#4a9eff" : "#888", fontSize: "13px", letterSpacing: "2px", textTransform: "uppercase" }}>
                  {tab === "sections" ? "üìö Study Sections" : "‚ö° Flashcards"}
                </button>
              ))}
              <VoiceSettingsPanel voiceSettings={voiceSettings} setVoiceSettings={setVoiceSettings} />
            </div>
          </div>

          <div style={{ maxWidth: "900px", margin: "0 auto", padding: "24px 16px 100px" }}>

            {activeTab === "sections" && sections.map(section => (
              <div key={section.id} style={{ marginBottom: "12px" }}>
                <div style={{ background: activeSection === section.id ? `linear-gradient(135deg, ${section.color}, #0a0a0f)` : "#111118", border: `1px solid ${activeSection === section.id ? section.accent + "66" : "#222"}`, borderRadius: "12px", padding: "16px 20px", display: "flex", alignItems: "center", gap: "12px" }}>
                  <span style={{ fontSize: "22px" }}>{section.emoji}</span>
                  <span onClick={() => setActiveSection(activeSection === section.id ? null : section.id)} style={{ flex: 1, fontSize: "17px", fontWeight: 700, cursor: "pointer", color: activeSection === section.id ? section.accent : "#ddd" }}>{section.title}</span>
                  <SpeakBtn onClick={() => speakSection(section)} label={section.title} />
                  <span onClick={() => setActiveSection(activeSection === section.id ? null : section.id)} style={{ fontSize: "20px", color: section.accent, cursor: "pointer", transform: activeSection === section.id ? "rotate(90deg)" : "rotate(0deg)", transition: "transform 0.3s", display: "inline-block" }}>‚Ä∫</span>
                </div>

                {activeSection === section.id && (
                  <div style={{ marginTop: "4px", border: `1px solid ${section.accent}33`, borderTop: "none", borderRadius: "0 0 12px 12px", background: "#0d0d15" }}>
                    {section.items.map((item, idx) => (
                      <div key={idx} style={{ padding: "18px 20px", borderBottom: idx < section.items.length - 1 ? "1px solid #1a1a25" : "none" }}>
                        <div style={{ display: "flex", alignItems: "center", gap: "10px", marginBottom: "8px" }}>
                          <h3 style={{ margin: 0, color: section.accent, fontSize: "14px", fontWeight: 700, flex: 1 }}>{item.title}</h3>
                          <SpeakBtn onClick={() => speakItem(item, section.id, idx)} label={item.title} small />
                        </div>
                        <div style={{ background: `${section.accent}11`, border: `1px solid ${section.accent}33`, borderRadius: "8px", padding: "9px 13px", marginBottom: "10px", fontSize: "13px", color: section.accent, fontStyle: "italic" }}>
                          üß† {item.mnemonic}
                        </div>
                        <ul style={{ margin: 0, padding: 0, listStyle: "none" }}>
                          {item.facts.map((fact, i) => {
                            const isHighlighted = highlightedFact && highlightedFact.sectionId === section.id && highlightedFact.itemIdx === idx && highlightedFact.factIdx === i;
                            return (
                              <li key={i} className={isHighlighted ? "speaking-highlight" : ""} style={{ padding: "3px 0", fontSize: "13px", color: isHighlighted ? "#fff" : (fact.startsWith("‚Üí") || fact.startsWith(" ") ? "#777" : "#bbb"), paddingLeft: fact.startsWith("‚Üí") || fact.startsWith(" ") ? "10px" : "0", lineHeight: "1.6", transition: "color 0.2s" }}>
                                {fact.startsWith("‚Üí") || fact.startsWith(" ") ? fact : `‚Ä¢ ${fact}`}
                              </li>
                            );
                          })}
                        </ul>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}

            {activeTab === "flashcards" && (
              <div>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "20px", flexWrap: "wrap", gap: "8px" }}>
                  <h2 style={{ margin: 0, fontSize: "18px", color: "#ccc" }}>‚ö° Quick-Fire Facts</h2>
                  <div style={{ display: "flex", gap: "8px", flexWrap: "wrap" }}>
                    {[["üîä Read All", speakAllFlashcards, "#4a9eff"], ["Hide All", () => setRevealed({}), "#888"], ["Reveal All", revealAll, "#4aff8a"]].map(([label, fn, color]) => (
                      <button key={label} onClick={fn} style={{ padding: "7px 14px", background: color + "22", border: `1px solid ${color}66`, borderRadius: "8px", color, fontSize: "13px" }}>{label}</button>
                    ))}
                  </div>
                </div>

                <div style={{ display: "grid", gap: "8px", gridTemplateColumns: "repeat(auto-fill, minmax(250px, 1fr))" }}>
                  {quickFacts.map((fact, idx) => (
                    <div key={idx} style={{ background: "#111118", border: "1px solid #222", borderRadius: "10px", padding: "14px" }}>
                      <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "8px" }}>
                        <div style={{ fontSize: "12px", color: "#999" }}>Q: {fact.q}</div>
                        <button onClick={() => speakFlashcard(fact)} style={{ background: "transparent", border: "none", color: "#666", cursor: "pointer", fontSize: "13px" }}>üîä</button>
                      </div>
                      <div onClick={() => toggleReveal(idx)} style={{ fontSize: "15px", fontWeight: 700, cursor: "pointer", color: revealed[idx] ? "#4aff8a" : "#333", background: revealed[idx] ? "transparent" : "#1a1a1a", borderRadius: "4px", padding: revealed[idx] ? "0" : "2px 8px", minHeight: "22px" }}>
                        {revealed[idx] ? fact.a : "tap to reveal ‚Üí"}
                      </div>
                    </div>
                  ))}
                </div>

                <div style={{ marginTop: "36px" }}>
                  <div style={{ display: "flex", alignItems: "center", gap: "12px", marginBottom: "14px" }}>
                    <h2 style={{ color: "#ff7a4a", fontSize: "17px", margin: 0 }}>üî• Critical Numbers</h2>
                    <button onClick={speakCheatSheet} style={{ padding: "6px 14px", background: "#ff7a4a22", border: "1px solid #ff7a4a66", borderRadius: "8px", color: "#ff7a4a", fontSize: "13px" }}>üîä Read</button>
                  </div>
                  <div style={{ background: "#111118", border: "1px solid #ff7a4a33", borderRadius: "12px", overflow: "hidden" }}>
                    {[["20 hours","Pre-licensing education"],["8 hours","Annual CE"],["75%","SAFE exam passing score"],["3 business days","Loan Estimate delivery"],["3 business days","Closing Disclosure (before closing)"],["3.5%","FHA min down payment (580+)"],["1.75%","FHA upfront MIP"],["0.55%","FHA annual MIP (most borrowers, 30-yr)"],["$832,750","2026 conforming loan limit"],["$1,249,125","2026 high-cost area ceiling"],["78% LTV","PMI auto-cancellation"],["43%","Max QM back-end DTI"],["2 months","Max RESPA escrow cushion"],["30 days","ECOA adverse action notice"],["25 months","ECOA recordkeeping"],["62 years","Reverse mortgage minimum age"],["120 days","Temporary MLO authority"],["$59 million","HMDA asset exemption threshold (2026)"],["$10,000 + 1 yr","RESPA Section 8 penalty"],["3 years","Extended right of rescission"],["2%","HECM upfront MIP"]].map(([num, desc], i, arr) => (
                      <div key={i} style={{ display: "flex", alignItems: "center", padding: "11px 18px", borderBottom: i < arr.length - 1 ? "1px solid #1a1a25" : "none", background: i % 2 === 0 ? "transparent" : "#ffffff04" }}>
                        <span style={{ fontWeight: 800, color: "#ff7a4a", fontSize: "14px", minWidth: "140px", fontFamily: "monospace" }}>{num}</span>
                        <span style={{ color: "#bbb", fontSize: "13px" }}>{desc}</span>
                      </div>
                    ))}
                  </div>
                </div>

                <div style={{ marginTop: "28px", background: "linear-gradient(135deg, #1a1a2e, #0f1a0f)", border: "1px solid #4aff8a44", borderRadius: "12px", padding: "22px" }}>
                  <h2 style={{ color: "#4aff8a", margin: "0 0 14px", fontSize: "17px" }}>üí° Last-Minute Tips</h2>
                  {["üéØ TRID: LE in 3 days after app. CD 3 days BEFORE closing.","üéØ FHA = HUD. VA = VA Dept. USDA = Agriculture. Ginnie Mae = GNMA (govt).",
                  "üéØ ECOA = credit decisions. Fair Housing = property transactions.",
                  "üéØ Processor does NOT need license UNLESS independent judgment.",
                  "üéØ Zero tolerance = origination charges. Cannot increase. Ever.",
                  "üéØ Right of rescission = REFINANCE only. NOT purchase. 3 days.",
                  "üéØ Steering + Redlining + Blockbusting = ALL illegal.",
                  "üéØ MLO compensation cannot be based on loan terms.",
                  "üéØ QM = safe harbor. ATR must ALWAYS be verified.",
                  "üéØ SAR = $5,000 suspicious. CTR = $10,000 cash. Never tip off subject.",
                  "üéØ Business day for rescission INCLUDES Saturday, excludes Sunday & holidays.",
                  "üéØ Appraiser independence: MLO CANNOT pressure, suggest value, or withhold payment.",
                  "üéØ Occupancy fraud = claiming primary when it's investment = FRAUD.",
                  "üéØ Fraud for profit (industry insider) is MORE serious than fraud for property.",
                  "üéØ UDAAP: Unfair + Deceptive + ABUSIVE ‚Äî CFPB authority post Dodd-Frank.",
                  "üéØ Secondary market: Fannie/Freddie buy conventional. Ginnie backs FHA/VA/USDA.",
                  "üéØ DTI uses GROSS income ‚Äî before taxes, not take-home pay.",
                  "üéØ LTV uses LESSER of purchase price or appraised value.",
                  ].map((tip, i, arr) => (
                    <div key={i} style={{ padding: "7px 0", borderBottom: i < arr.length - 1 ? "1px solid #1a2a1a" : "none", fontSize: "13px", color: "#ccc", lineHeight: "1.6" }}>{tip}</div>
                  ))}
                </div>
              </div>
            )}
          </div>

          <div style={{ position: "fixed", bottom: 0, left: 0, right: 0, background: "linear-gradient(90deg, #1a3a5c, #0f3460)", borderTop: "1px solid #4a9eff44", padding: "11px 24px", textAlign: "center", fontSize: "12px", color: "#4a9eff", letterSpacing: "2px" }}>
            üéì YOU GOT THIS ‚Äî GOOD LUCK ON YOUR NMLS EXAM!
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
